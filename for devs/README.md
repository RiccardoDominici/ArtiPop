# ArtiPop v3

ArtiPop v3 generates high-quality images with Stability AI's Stable Diffusion 3.5 Large model through the Replicate API and uploads the rendered artwork to an Amazon S3 bucket. The system runs on AWS, leveraging both EC2 (for compute) and S3 (for storage), and all commands can be executed via AWS Console Connect. The repository also includes a daily automation script that rotates through curated prompts, manages logging, and can notify downstream services when fresh images are available.

## Key Features
- CLI utility (`main.py`) for prompt-driven image generation backed by Replicate.
- Automatic PNG metadata embedding (prompt, guidance, seed, timestamps).
- S3 uploads with rich object metadata and optional public URL handling.
- Daily automation script with rotating prompts, log retention, and URL history.
- Optional hooks for Telegram, Slack, Discord, or SES notifications.

## Requirements
- Python 3.9 or newer.
- Replicate account and API token with access to `stability-ai/stable-diffusion-3.5-large`.
- AWS credentials with `s3:PutObject` (and optionally `s3:GetObject`) access to your target bucket.
- Dependencies listed in `requirements.txt` (install via `pip install -r requirements.txt`).

## Setup
1. Make sure you have an active AWS account with Management Console access.
2. Create an EC2 instance and an S3 bucket that will be used for execution and storage respectively.
   Refer to the `configuration_steps` file for a step-by-step guide to configuring the EC2 instance.
3. Copy `secret_example.env` to `secrets.env` (or another `.env` file) and fill in the required fields:
   ```env
   AWS_ACCESS_KEY_ID=...
   AWS_SECRET_ACCESS_KEY=...
   AWS_DEFAULT_REGION=eu-central-1
   S3_BUCKET=your-bucket-name
   REPLICATE_API_TOKEN=...
   ```
   Replace the placeholders (`...`) with your AWS credentials, bucket name, and Replicate token.

## Running the Generator
From an activated virtual environment, run:
```bash
python3 main.py \
  --bucket your-bucket-name \
  --prompt "a photorealistic portrait of a cyberpunk explorer" \
  --organized \
  --public \
  --region eu-central-1
```

Key arguments:
- `--bucket` (required if `S3_BUCKET` is not set): target S3 bucket.
- `--prompt` (required): text description for the image.
- `--key`: custom S3 object key; autogenerated if omitted.
- `--organized`: store images under `images/YYYY/MM/DD/filename.png`.
- `--steps`, `--guidance`, `--seed`, `--width`, `--height`: optional generation controls (some parameters are retained for compatibility; Stable Diffusion 3.5 Large mainly uses CFG and aspect ratio).
- `--public`: mark the upload as publicly readable and print the HTTPS URL.
- `--region`: override the AWS region (falls back to `AWS_DEFAULT_REGION` or `eu-central-1`).

On success the script prints a formatted summary, including the S3 URI and—if requested—the public URL. The final line always echoes the S3 URI, which simplifies automation or piping to other tools.

## Daily Automation
The `daily_generation.sh` script runs a scheduled generation with a rotating prompt list.

Highlights:
- Loads environment variables from `secrets.env` and an optional `.env`.
- Activates the `sd3-env` virtual environment before execution.
- Maintains a timestamped log (`logs/sd3_YYYYMMDD_HHMMSS.log`) for each run.
- Records generated public URLs in `logs/generated_urls.txt`.
- Keeps the last 30 days of logs (older files are deleted automatically).

### Configure Cron (example)
Make the script executable and register a cron job:
```bash
chmod +x daily_generation.sh
crontab -e
```
Example entry (runs once every 24 hours):
```
0 */24 * * * /absolute/path/to/daily_generation.sh >> /absolute/path/to/logs/cron.log 2>&1
```
Adjust the schedule, paths, or prompt list (`PROMPTS` array) to suit your workflow.

## Logging and History
- Real-time progress is mirrored to both STDOUT and the active log file via the `log()` helper in `daily_generation.sh`.
- The Python script uses the standard logging module (INFO level). Look for `Fatal error` entries when debugging failures.
- Each upload stores prompt, guidance, and generation timestamps inside both the PNG metadata and the S3 object metadata for easy auditing.

## Notifications (Optional)
`daily_generation.sh` includes a `send_notification` stub with commented examples for:
- Telegram bot messages or photo uploads.
- Slack incoming webhooks.
- Amazon SES email delivery.
- Discord webhooks.

Uncomment and adapt the preferred block, ensuring the relevant environment variables (e.g., `TELEGRAM_BOT_TOKEN`, `SLACK_WEBHOOK_URL`) are defined.

## Troubleshooting
- **Missing Replicate token:** Ensure `REPLICATE_API_TOKEN` is exported or present in your `.env`; the script fails fast if the token is missing or invalid.
- **S3 permissions:** Confirm the IAM policy allows `s3:PutObject` on your bucket. Use the provided sample policy in `Policy IAM` to grant public read access if you want to expose generated assets.
- **Network errors or 404 model slug:** Verify the model ID (`stability-ai/stable-diffusion-3.5-large`) is available to your Replicate account.
- **Cron issues:** Check `logs/cron.log` (or your chosen location) to confirm the environment is activated and paths are correct inside the scheduled job.

## License
This project does not currently include an explicit license. If you plan to share or modify it publicly, consider adding an open-source license that suits your needs.
